name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog extraction
      
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract the changelog section for this version
          VERSION="${{ steps.version.outputs.version }}"
          
          # Get content between this version header and the next version header
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if (index($0, ver)) found=1
              next
            }
            found { print }
          ' CHANGELOG.md)
          
          # If no changelog found, use a default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See CHANGELOG.md for details."
          fi
          
          # Write to file to preserve multiline
          echo "$CHANGELOG" > changelog_extract.txt
      
      - name: Find APK
        id: apk
        run: |
          # Look for APK in releases folder (pushed by release.sh)
          APK_PATH="releases/Sage_${{ steps.version.outputs.version }}.apk"
          
          if [ -f "$APK_PATH" ]; then
            echo "path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_PATH"
          else
            echo "APK not found at $APK_PATH"
            echo "Available files in releases/:"
            ls -la releases/ || echo "releases/ directory not found"
            exit 1
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Silicon Sage v${{ steps.version.outputs.version }}
          body_path: changelog_extract.txt
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'dev') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          files: |
            ${{ steps.apk.outputs.path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release summary
        run: |
          echo "âœ… Released Silicon Sage v${{ steps.version.outputs.version }}"
          echo "ðŸ“¦ APK: ${{ steps.apk.outputs.path }}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
